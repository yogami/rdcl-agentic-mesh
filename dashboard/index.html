<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Mesh Router Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .node {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .node-label {
            position: absolute;
            font-size: 10px;
            color: #94a3b8;
            margin-top: 15px;
            margin-left: -15px;
            width: 60px;
            text-align: center;
        }
        .high-congestion { background-color: #ef4444; box-shadow: 0 0 15px #ef4444; }
        .med-congestion { background-color: #f59e0b; box-shadow: 0 0 15px #f59e0b; }
        .low-congestion { background-color: #10b981; box-shadow: 0 0 15px #10b981; }
        
        #mesh-canvas {
            position: relative;
            width: 100%;
            height: 600px;
            background-color: #1e293b;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #334155;
        }
        .pulse { animation: pulse-animation 1s infinite; }
        @keyframes pulse-animation {
            0% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: translate(-50%, -50%) scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto flex flex-col gap-6">
        
        <header class="flex justify-between items-center border-b border-slate-700 pb-4">
            <div>
                <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
                    rdcl::tools | Agentic Mesh Router
                </h1>
                <p class="text-slate-400 text-sm mt-1">Cognitive routing layer for highly congested LoRa networks.</p>
            </div>
            <div class="flex gap-4 text-sm">
                <div class="bg-slate-800 px-4 py-2 rounded border border-slate-700">
                    <span class="text-slate-400 block text-xs">Policy Engine</span>
                    <span id="stat-policy" class="font-bold text-blue-400">Loading...</span>
                </div>
                <div class="bg-slate-800 px-4 py-2 rounded border border-slate-700">
                    <span class="text-slate-400 block text-xs">Total Transmissions</span>
                    <span id="stat-tx" class="font-bold text-emerald-400">0</span>
                </div>
                <div class="bg-slate-800 px-4 py-2 rounded border border-slate-700">
                    <span class="text-slate-400 block text-xs">Collisions (Simulated)</span>
                    <span id="stat-col" class="font-bold text-red-400">0</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left: Visualization -->
            <div class="lg:col-span-2 flex flex-col gap-4">
                <h2 class="text-lg font-semibold text-slate-200">Live Network Topology</h2>
                <div id="mesh-canvas">
                    <!-- Nodes will be injected here -->
                </div>
            </div>

            <!-- Right: Agentic Reasoning Log -->
            <div class="flex flex-col gap-4">
                <h2 class="text-lg font-semibold text-slate-200">Agentic Reasoning Log</h2>
                <div id="log-container" class="bg-slate-800 rounded-lg p-4 font-mono text-xs text-slate-300 h-[600px] overflow-y-auto border border-slate-700 flex flex-col gap-2">
                    <!-- Logs injected here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        const canvas = document.getElementById('mesh-canvas');
        const logContainer = document.getElementById('log-container');
        
        // Scale 1500m coordinate system to 100% canvas size
        const scaleX = (x) => (x / 1500) * 100;
        const scaleY = (y) => (y / 1500) * 100;

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            // Update Stats
            document.getElementById('stat-policy').innerText = data.stats.policy || "Unknown";
            document.getElementById('stat-tx').innerText = data.stats.transmissions;
            document.getElementById('stat-col').innerText = data.stats.collisions;

            // Render Nodes
            if (data.nodes) {
                Object.values(data.nodes).forEach(node => {
                    let el = document.getElementById(`node-${node.id}`);
                    if (!el) {
                        el = document.createElement('div');
                        el.id = `node-${node.id}`;
                        
                        const label = document.createElement('div');
                        label.className = 'node-label';
                        label.innerText = node.id;
                        el.appendChild(label);
                        
                        canvas.appendChild(el);
                    }
                    
                    // Update position
                    el.style.left = `${scaleX(node.x)}%`;
                    el.style.top = `${scaleY(node.y)}%`;
                    
                    // Congestion styling
                    el.className = 'node ';
                    if (node.inbox_size > 30) {
                        el.className += 'high-congestion pulse';
                    } else if (node.inbox_size > 10) {
                        el.className += 'med-congestion';
                    } else {
                        el.className += 'low-congestion';
                    }
                });
            }

            // Render Logs
            if (data.logs) {
                logContainer.innerHTML = '';
                // Show latest first
                [...data.logs].reverse().forEach(log => {
                    const el = document.createElement('div');
                    el.className = 'p-2 rounded bg-slate-900 border border-slate-700 flex flex-col gap-1';
                    
                    let actionColor = log.action === 'FORWARD' ? 'text-emerald-400' : 'text-red-400';
                    if (log.action === 'RECEIVED') actionColor = 'text-blue-400';
                    
                    el.innerHTML = `
                        <div class="flex justify-between">
                            <span class="font-bold text-slate-400">${log.node_id}</span>
                            <span class="font-bold ${actionColor}">${log.action}</span>
                        </div>
                        <div class="text-yellow-200">"${log.payload}"</div>
                        <div class="text-[10px] text-slate-500 text-right">Congestion: ${log.congestion}</div>
                    `;
                    logContainer.appendChild(el);
                });
            }
        };
    </script>
</body>
</html>
